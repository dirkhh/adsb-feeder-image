#!/usr/bin/env bash
# overall distro module for ADSB.im feeder image
# Written by Dirk Hohndel <dirk@hohndel.org>
# GPL V3
########


# Source error handling, leave this in place
set -x
set -e

source /common.sh
install_cleanup_trap

unpack /filesystem/root /

# free up space
apt-get autoremove -y gcc-12 dpkg-dev gdb build-essential mkvtoolnix iso-codes shared-mime-info rpicam-apps-lite\* || true

echo "building on $(hostname) - available disk space inside the image:"
df -h
mount
echo "127.0.1.1 $(hostname)" 2>/dev/null >> /etc/hosts

# brute force set up an authorized_keys file for root
mkdir -p ~root/.ssh
echo "$SSH_PUB_KEY" >> ~root/.ssh/authorized_keys
echo "$SSH_PUB_KEY" > ~root/.ssh/adsb.im.installkey
touch /opt/adsb/adsb.im.passwd.and.keys

# zerotier and tailscale repos

DEBIAN_DISTRO=$(head -1 /etc/apt/sources.list | cut -d\  -f 3)
echo "deb http://download.zerotier.com/debian/${DEBIAN_DISTRO} ${DEBIAN_DISTRO} main" > /etc/apt/sources.list.d/zerotier.list
curl -fsSL "https://pkgs.tailscale.com/stable/debian/${DEBIAN_DISTRO}.noarmor.gpg" | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
curl -fsSL "https://pkgs.tailscale.com/stable/debian/${DEBIAN_DISTRO}.tailscale-keyring.list" | sudo tee /etc/apt/sources.list.d/tailscale.list

# setup Python/Flask
apt-get update --allow-releaseinfo-change

if grep -q "bullseye" /etc/os-release ; then
	# for older Debian the packaged flask is still v1 and too old for our code
	# on the flipside, bullseye still allows us to use pip to install
	# systemwide packages - so let's do it this way
	apt-get install -y --no-install-recommends python3 python3-pip
	pip install --no-cache-dir -r /opt/adsb/adsb-setup/requirements.txt
	ln -s /usr/local/bin/flask /usr/bin
	if [ "$BASE_DISTRO" = "raspbian" ] ; then
		# for Dozzle to work, Raspbian needs a slightly modified command.txt
		sed -i 's/rootwait/rootwait cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1/' /boot/cmdline.txt
	fi
else
	apt-get install -y --no-install-recommends python3 python3-flask python3-requests
fi

# install chrony for better time synchronization compared to systemd-timesyncd
apt-get install -y --no-install-recommends chrony

if [ "$FEEDER_IMAGE_NAME" != "" ] ; then
	echo "$FEEDER_IMAGE_NAME" > /opt/adsb/feeder-image.name
else
	echo "custom built feeder image" > /opt/adsb/feeder-image.name
fi
echo "Using feeder image name $(cat /opt/adsb/feeder-image.name)"

# setup initial .env with container versions
mkdir -p /opt/adsb/config
ENV_FILE=/opt/adsb/config/.env
cp /opt/adsb/docker.image.versions "$ENV_FILE"
echo "_ADSBIM_BASE_VERSION=$(cat /opt/adsb/adsb.im.version)" >> "$ENV_FILE"
echo "_ADSBIM_CONTAINER_VERSION=$(cat /opt/adsb/adsb.im.version)" >> "$ENV_FILE"

rm -f /boot/ADSB-README.txt

# Install dependencies
apt-get install -y gnupg hostapd isc-dhcp-server avahi-utils
systemctl mask hostapd.service
systemctl mask isc-dhcp-server.service

# install zerotier and tailscale, first get their repo
# don't enable

apt-get install -y zerotier-one tailscale
systemctl disable tailscaled
systemctl disable zerotier-one

# disable swapfile, we have swap on zram
systemctl disable dphys-swapfile || true

# Disable telemetry for tailscale
# but only if it's not already there
if ! grep -q -- "^FLAGS=\"--no-logs-no-support" /etc/default/tailscaled ; then
	sed -i 's/FLAGS=\"/FLAGS=\"--no-logs-no-support /' /etc/default/tailscaled
fi

# If we are armbian, we do something with networking
if [ "$BASE_DISTRO" = "armbian" ] ; then
	apt-get install -y network-manager net-tools

	echo "127.0.0.1 adsb-feeder.local" >> /etc/hosts

	# ensure that we get predictable interface names
	echo "extraargs=net.ifnames=0" >> /boot/armbianEnv.txt
	if [[ -f /usr/lib/systemd/system/armbian-firstrun-config.service ]] ; then
		sed -i 's/Wants=network-online.target/Wants=network-pre.target/;s/After=network.target network-online.target/Before=wpa_supplicant.service network.target network-online.target/' /usr/lib/systemd/system/armbian-firstrun-config.service
		systemctl list-unit-files armbian-firstrun-config &>/dev/null && systemctl enable armbian-firstrun-config
	fi
fi

# Enable services at boot
systemctl enable adsb-setup.service
systemctl enable adsb-docker.service
systemctl enable adsb-bootstrap.service
systemctl enable adsb-hotspot.service
systemctl enable adsb-zram.service
systemctl enable adsb-update.timer

# Disable some things we don't need and that only eat memory (assuming they exist)
systemctl disable bluetooth.service || true
systemctl disable ModemManager.service || true


# finally, create a flag file as indicator that this is a complete ADS-B Feeder
# Image, and not just the app running on a different OS.
touch /opt/adsb/os.adsb.feeder.image

