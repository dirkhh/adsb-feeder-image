{% extends 'base.html' %}
{% set active_page = "setup" %}

{% block content %}
<h1 class="mt-3 text-center text-danger">{% block title %} Basic Setup {% endblock %}</h1>
<div class="alert alert-danger" role="alert" {% if env_value_by_tag('dns_state') %} style="display: none;" {% endif %}>
  The feeder cannot resolve DNS queries. This will most likely prevent it from working at all.
</div>
<p>
  The data below should match the exact location of your antenna (for a normal feeder). You can use the
  <a href="https://www.freemaptools.com/elevation-finder.htm" target="_blank">location and elevation finder tool</a>
  to find your Latitude, Longitude, and Altitude based on your address.
</p>
<p>
  For a <strong>Stage 2</strong> feeder that connects with already running micro feeder(s), the data here defines the
  position you want to be the center of your combined map display. Make sure you select <strong>Stage 2 Setup</strong>
  below.
</p>
<p class="row">
  <span class="col-md">
    If you are re-installing the ADS-B Feeder Image and have made a backup of your configuration, you can also simply
    restore those settings
  </span>
  <span class="col-md">
    <a class="btn btn-secondary" href="{{  url_for('restore') }}">restore previous backup</a>
  </span>
</p>
<form method="post" onsubmit="show_spinner(); return true;" action="{{ url_for('setup') }}">
  <div class="form-group row align-items-center mb-1">
    <span class="col-md">
      <label for="site_name">Station Name (shows up on public maps if enabled later)</label>
    </span>
    <span class="col-md">
      <input type="text" id="site_name" name="site_name" required placeholder="my-awesome-antenna" class="form-control"
             pattern="[\-_.a-zA-Z0-9 ]+" title="Letters, numbers, -, _, ."
             value="{{ list_value_by_tag('site_name', 0) }}" />
    </span>
  </div>
  <div class="form-group row align-items-center mb-1">
    <span class="col-md">
      <label for="lat">Latitude (-90 .. +90 -- please use 5 decimals, e.g. 45.12345)</label>
    </span>
    <span class="col-md">
      <input type="text" id="lat" name="lat" required placeholder="Antenna latitude" class="form-control"
             pattern="(?:\+|-|)(?:(?:[0-8]?\d)(?:\.\d+)?|90(?:\.0+)?)(,(?:\+|-|)(:?(:?\d?\d|1[0-7]\d)(?:\.\d+)?|180(?:\.0+)?))?"
             title="Number between -90 and 90" value="{{ list_value_by_tag('lat', 0) }}" />
    </span>
  </div>
  <div class="form-group row align-items-center mb-1">
    <span class="col-md">
      <label for="lon">Longitude (-180 .. +180 -- please use 5 decimals , e.g. -122.12345)</label>
    </span>
    <span class="col-md">
      <input type="text" id="lon" name="lon" required placeholder="Antenna longitude" class="form-control"
             pattern="(?:\+|-|)(:?(:?\d?\d|1[0-7]\d)(?:\.\d+)?|180(?:\.0+)?)" title="Number between -180 and 180"
             value="{{ list_value_by_tag('lon', 0) }}" />
    </span>
  </div>
  <div class="form-group row align-items-center mb-1">
    <span class="col-md">
      <label for="alt">Altitude above mean sealevel, rounded to whole meters</label>
    </span>
    <span class="col-md">
      <input type="text" id="alt" name="alt" required placeholder="in m - or add 'ft' to enter in ft" class="form-control"
             pattern="(?:\+|-|)\d+(?:m|ft)" value="{{ list_value_by_tag('alt', 0) }}" />
    </span>
  </div>
  <div class="form-group row align-items-center mb-1">
    <span class="col-md">
      <label for="tz">Timezone</label>
      <button class="pb-1 btn btn-secondary"
              onclick="updateTimezone(); return false; // return false inhibits the form to be submitted">update
        timezone</button>
    </span>
    <span class="col-md">
      <input type="text" name="tz" id="tz" required
             placeholder="populate from the browser timezone by clicking the 'update timezone' button"
             class="form-control mt-2" value="{{ list_value_by_tag('tz', 0) }}" />
    </span>
  </div>
  <div class="mt-3">
    Closest airport suggestion: <span id="airport"></span>
  </div>
  <div class="form-group mt-3">
    <h4>What data do you want to track?</h4>
    <div>Simply click the button for each data type you want to track -- you can always change this later.</div>
    <div class="row">
      <div class="col-12 col-md-6 col-lg-4 mt-2">
        <button type="button" class="btn btn-large btn-primary w-100 with-checkbox" id="adsb_button" data-mdb-ripple-init><input type="checkbox" class="me-2" name="is_adsb_feeder" id="is_adsb_feeder"
               {% if env_value_by_tag("is_adsb_feeder") %} checked {% endif %}> ADS-B</button>
        <div class="row inner w-100 d-none mx-2">
          Select the type of feeder (explanations below):
          <label class="form-check-label" for="adsb_integrated"><input type="radio" name="aggregator_choice" id="adsb_integrated" value="integrated" class="me-2"
                 {% if env_value_by_tag("aggregator_choice")  == "integrated" or env_value_by_tag("aggregator_choice") == "all" or env_value_by_tag("aggregator_choice") == "privacy" or env_value_by_tag("aggregator_choice") == "individual" %} checked {% endif %}> Default (integrated)</label>
          <label class="form-check-label" for="adsb_micro"><input type="radio" name="aggregator_choice" id="adsb_micro" value="micro" class="me-2"
                 {% if env_value_by_tag("aggregator_choice")=="micro" %} checked {% endif %}> Micro</label>
          <label class="form-check-label" for="adsb_nano"><input type="radio" name="aggregator_choice" id="adsb_nano" value="nano" class="me-2"
                 {% if env_value_by_tag("aggregator_choice")=="nano" %} checked {% endif %}> Nano</label>
          <label class="form-check-label" for="adsb_stage2"><input type="radio" name="aggregator_choice" id="adsb_stage2" value="stage2" class="me-2"
                 {% if env_value_by_tag("aggregator_choice")=="stage2" %} checked {% endif %}> Stage 2</label>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-4 mt-2">
        <button type="button" class="btn btn-large btn-primary w-100 with-checkbox" data-mdb-ripple-init><input type="checkbox" class="me-2" name="is_acars_feeder"
               {% if is_enabled('is_acars_feeder') %} checked {% endif %}> ACARS / VDL2</button>
        <div class="row inner w-100 d-none mx-2 mt-1 d-flex">
          <div>
            <label class="form-check-label" for="acarsdec"><input type="checkbox" class="me-2" name="acarsdec" {% if is_enabled('acarsdec') %} checked {% endif %}
              >{% if env_value_by_tag('acars_feed_id') != "" %}{{ env_value_by_tag('acars_feed_id') }}
              {% else %}<span class="initials_class"></span>-<span class="airport_icao"></span>-ACARS{% endif %}</label><br>
            <label class="form-check-label" for="acarsdec2"><input type="checkbox" class="me-2" name="acarsdec2" {% if is_enabled('acarsdec2') %} checked {% endif %}
              >{% if env_value_by_tag('acars_2_feed_id') != "" %}{{ env_value_by_tag('acars_2_feed_id') }}
              {% else %}<span class="initials_class"></span>-<span class="airport_icao"></span>-ACARS2{% endif %}</label><br>
            <label class="form-check-label" for="dumpvdl2"><input type="checkbox" class="me-2" name="dumpvdl2" {% if is_enabled('dumpvdl2') %} checked {% endif %}
              >{% if env_value_by_tag('vdl2_feed_id') != "" %}{{ env_value_by_tag('vdl2_feed_id') }}
              {% else %}<span class="initials_class"></span>-<span class="airport_icao"></span>-VDL2{% endif %}</label>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-4 mt-2">
        <button type="button" class="btn btn-large btn-primary w-100 with-checkbox" data-mdb-ripple-init><input type="checkbox" class="me-2" name="is_hfdl_feeder"
               {% if is_enabled('is_hfdl_feeder') %} checked {% endif %}> HFDL</button>
        <div class="row inner w-100 d-none mx-2 mt-1 d-flex">
          <div>
            <label class="form-check-label" for="dumphfdl"><input type="checkbox" class="me-2" name="dumphfdl"
                     {% if is_enabled('dumphfdl') %} checked {% endif %}
                     >{% if env_value_by_tag('hfdl_feed_id') != "" %}{{ env_value_by_tag('hfdl_feed_id') }}
                    {% else %}<span class="initials_class"></span>-<span class="airport_icao"></span>-HFDL (SDR){% endif %}</label>
            <label class="form-check-label" for="hfdlobserver"><input type="checkbox" class="me-2" name="hfdlobserver"
                     {% if is_enabled('hfdlobserver') %} checked {% endif %}
                     >{% if env_value_by_tag('hfdlobserver_feed_id') != "" %}{{ env_value_by_tag('hfdlobserver_feed_id') }}
                    {% else %}<span class="initials_class"></span>-<span class="airport_icao"></span>-HFDL (WEB-888){% endif %}</label>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-4 mt-2">
        <button type="button" class="btn btn-large btn-primary w-100 with-checkbox" data-mdb-ripple-init><input type="checkbox" class="me-2" name="is_ais_feeder"
               {% if is_enabled('is_ais_feeder') %} checked {% endif %}> AIS</button>
        <div class="row inner w-100 d-none mx-2 mt-1 d-flex">
          <div>
            <label class="form-check-label">{% if env_value_by_tag('ais_station_name') != "" %}{{ env_value_by_tag('ais_station_name') }}
            {% else %}<span class="initials_class"></span>-<span class="airport_icao"></span>-AIS{% endif %}
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-4 mt-2">
        <button type="button" class="btn btn-large btn-primary w-100 with-checkbox" data-mdb-ripple-init><input type="checkbox" class="me-2" name="is_sonde_feeder"
               {% if is_enabled('is_sonde_feeder') %} checked {% endif %}> SONDE</button>
      </div>
      <div class="col-12 col-md-6 col-lg-4 mt-2 d-none" id="initials_div">
        <label class="form-check-label" for="initials">Initials for non-ADS-B station names:
          <input type="text" class="initials_class" name="initials" id="initials" style="width: 6em;" placeholder="initials"
                  value="{{ list_value_by_tag('initials', 0) }}" oninput="propagateInitials(this);" data-1p-ignore />
        </label>
      </div>
    </div>
  </div>
  <br>
  <div class="form-group">
    <button type="submit" name="submit" value="go" class="btn btn-primary btn-rounded btn-block btn-lg p-4 mb-3">Apply</button>
  </div>
  <p>{{ message }}</p>
</form>
<div id="explain-adsb" class="{% if not env_value_by_tag("is_adsb_feeder") %} d-none {% endif %} mt-4 small">
  <h5>Explanation of the ADS-B feeder types</h5>
  <div id="explain-integrated">
    <strong>Integrated Feeder:</strong> This is the default option that most users will want. Collect data using attached SDRs and send to one or more aggregators.
  </div>
  <div id="explain-micro">
    <strong>Micro Feeder:</strong> Collect data using attached SDRs and otherwise
    minimize memory use and disable local features.
    Designed to work with a second stage image that uses this
    feeder as its input and creates the map, feeds the aggregators, etc.
  </div>
  <div id="explain-nano">
    <strong>Nano Feeder:</strong> Collect data using attached SDRs and otherwise
    minimize memory use even more and disable most local features, including the graphs running on the nano feeder.
    Designed to work with a second stage image that uses this feeder as its input and creates the map, feeds
    the aggregators, etc. Compared to the micro feeder option this is additionally optimized to reduce disk IO.
  </div>
  <div id="explain-stage2">
    <strong>Stage 2:</strong>
    Designed to connect to one or more micro feeder(s).
    You can select for each of them individually which aggregators you want to feed, and you get a combined map of all
    the planes that the micro feeder(s) see.
    <br>
    {% if mem < 1800000 %} WARNING: Stage 2 setup with only {{ (mem / 1024) | int }} MB of memory
    (400 to 600MB per microsite recommended){% endif %}
  </div>
          </div>

<script>
  $("#lat").on("blur", async function () {
    let lat_value = $("#lat").val();
    let values = lat_value.split(",");
    if (values.length > 1) {
      $("#lat").val(values[0]);
      $("#lon").val(values[1]);
    }
    await checkAirport();
  });
  $("#lon").on("blur", async function () {
    await checkAirport();
  })
  let a_lat = "";
  let a_lon = "";

  async function checkAirport() {
    let lat = $("#lat").val();
    let lon = $("#lon").val();
    if (lat != "" && lon != "" && (lat != a_lat || lon != a_lon)) {
      a_lat = lat;
      a_lon = lon;
      let url = "/api/closest_airport/" + lat + "/" + lon;
      fetch(url)
      .then(response => response.json())
      .then(airport_json => {
        // console.log(`closest_airport(${lat}, ${lon}) -> ${JSON.stringify(airport_json)}`);
        let airport_str = "";
        if (airport_json != null) {
          airport_str = airport_json["icao"] + " (" + airport_json["name"] + ")";
        }
        $("#airport").html(airport_str);
        $(".airport_icao").each(function () {
          $(this).html(airport_json["icao"]);
        })
      })
      .catch(error => {
        console.log(`getAirport(${lat}, ${lon}) -> ${error}`);
        return null;
      });
    }
  }

  // for all buttons with class 'with-checkbox' toggle the checkbox when button is clicked
  $(".with-checkbox").each(function () {
    $(this).parent().find(".inner").toggleClass("d-none", !$(this).find("input").prop("checked"));
    if ($(this).prop("id") != "adsb_button" && $(this).find("input").prop("checked")) {
      $("#initials_div").removeClass("d-none");
    }
    $(this).on("click", function (ev) {
      if (ev.target == this) {
        // $(this).find("input").prop("checked", !$(this).find("input").prop("checked"));
        $(this).find("input").trigger("click");
      }
      $(this).parent().find(".inner").toggleClass("d-none", !$(this).find("input").prop("checked"));
      if ($(this).prop("id") != "adsb_button" && $(this).find("input").prop("checked")) {
        $("#initials_div").removeClass("d-none");
      }
    });
  });
  $("#is_adsb_feeder").on("click", function () {
    $("#explain-adsb").toggleClass("d-none", !$(this).prop("checked"));
    if ($(this).prop("checked")) {
      // if nothing has been selected, default to integrated
      let $agg_choice = $("input[type='radio'][name='aggregator_choice']");
      if (!$agg_choice.filter(':checked').length) {
        $("#adsb_integrated").prop("checked", true);
      }
    }
  });

  function propagateInitials(element) {
    let initials = element.value;
    $('.initials_class').each(function () {
      if ($(this).is('span')) {
        console.log("it's a span", $(this).attr("id"));
        $(this).text(initials); }
      else {
        console.log("it's not a span", $(this).attr("id"));
        $(this).val(initials); }
    })
  }
  function fixAlt() {
    let alt_value = $("#alt").val();
    let factor = 1.0;
    if (alt_value.toLowerCase().includes("ft")) factor = 0.3048;
    let new_alt = Math.round(parseFloat(alt_value) * factor);
    if (new_alt.toString() == "NaN") new_alt = ""; else new_alt = new_alt + "m";
    $("#alt").val(new_alt);
  }
  $("#alt").on("blur", fixAlt);
  function browserTZ() {
    let timezone = "";
    try {
      timezone = Intl.DateTimeFormat("en-US").resolvedOptions().timeZone;
    } catch (error) {
      console.error(error);
    }
    console.log("browser timezone: " + timezone);
    return timezone;
  }
  function updateTimezone() {
    $("#tz").val(browserTZ());
  }
  // set timezone field to browser tz on load if not set already
  if (!$("#tz").val()) {
    $("#tz").val(browserTZ());
  }

  checkAirport()
  .catch(() => {
    console.log("checkAirport failed");
  });

  // run when the page finished loading using the ready function
  $(document).ready(function () {
    $('.initials_class').each(function () { $(this).text($("#initials").val()); });
    fixAlt();
  });
</script>
{% endblock %}
